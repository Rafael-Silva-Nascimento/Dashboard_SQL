<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | SQL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --cacique-yellow: #ffdb00; --cacique-dark: #121212; --cacique-sidebar: #1e1e1e; --cacique-red: #c0392b; }
        body { background-color: var(--cacique-dark); font-family: 'Segoe UI', sans-serif; color: #fff; overflow-x: hidden; }
        .sidebar { 
            background: var(--cacique-sidebar); 
            min-height: 100vh; 
            padding: 30px 20px; 
            border-right: 1px solid #333; 
            display: flex; 
            flex-direction: column; 
            position: sticky;
            top: 0;
        }
        .brand-area { text-align: center; margin-bottom: 30px; }
        .brand-name { color: var(--cacique-yellow); font-weight: 900; font-size: 1.6rem; margin: 0; letter-spacing: -1px; }
        .card { border: none; border-radius: 15px; background: #ffffff; box-shadow: 0 10px 20px rgba(0,0,0,0.3); margin-bottom: 20px; }
        .card h5 { font-size: 0.85rem; font-weight: 800; color: #333; text-transform: uppercase; border-bottom: 3px solid var(--cacique-yellow); display: inline-block; margin-bottom: 10px; padding-bottom: 5px; }
        .kpi-card { border-top: 5px solid var(--cacique-yellow); min-height: 110px; display: flex; flex-direction: column; justify-content: center; }
        .kpi-title { font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; padding: 5px; }
        .kpi-observed { background-color: var(--cacique-yellow); color: #121212 !important; font-weight: 800; border-radius: 4px; }
        .kpi-value { font-size: 1.2rem; font-weight: 900; color: #121212; margin-top: 5px; }
        .form-select, .form-control { background-color: #2d2d2d; border: 1px solid #444; color: #fff; font-size: 0.85rem; border-radius: 8px; }
        .chart-container { position: relative; height: 260px; width: 100%; }
        
        /* Rodapé V37 */
        .sidebar-footer { margin-top: auto; padding-top: 30px; font-size: 0.65rem; color: #666; text-align: center; font-style: italic; }

        #errorModal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal-content { background: #fff; color: #121212; margin: 3% auto; padding: 25px; border-radius: 15px; width: 92%; max-height: 90vh; overflow-y: auto; }
        .modal-header { border-bottom: 3px solid var(--cacique-yellow); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .table-error { font-size: 0.72rem; }
        .btn-close-modal { background: var(--cacique-red); color: white; border: none; padding: 6px 18px; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<div id="errorModal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="modalTitle" style="font-weight: 900; margin: 0;">DETALHES DE ERROS</h4>
            <button class="btn-close-modal" onclick="closeModal()">FECHAR</button>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover table-error">
                <thead>
                    <tr>
                        <th>DATA</th><th>ATENDENTE</th><th>LOJA</th><th>VENDEDOR</th><th>PEDIDO</th>
                        <th>ERRO_VENDA</th><th>RECLAMAÇÃO</th><th>FALHA</th><th>STATUS</th><th>TRATATIVA</th>
                    </tr>
                </thead>
                <tbody id="modalBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 sidebar">
            <div>
                <div class="brand-area"><h1 class="brand-name">CACIQUE</h1><span style="font-size:0.6rem; color:#888;">HOME CENTER | SQL</span></div>
                <div class="mb-3"><label style="font-size:0.7rem; color:var(--cacique-yellow);">IMPORTAR SQL.CSV</label><input type="file" id="csvInput" class="form-control form-control-sm" accept=".csv"></div>
                <div id="controls" style="display: none;">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label style="font-size:0.6rem; color:var(--cacique-yellow);">INÍCIO</label><input type="date" id="dateStart" class="form-control form-control-sm" onchange="applyFilters()"></div>
                        <div class="col-6"><label style="font-size:0.6rem; color:var(--cacique-yellow);">FIM</label><input type="date" id="dateEnd" class="form-control form-control-sm" onchange="applyFilters()"></div>
                    </div>
                    <div class="mb-3"><label style="font-size:0.7rem; color:var(--cacique-yellow);">LOJA</label><select id="filterLoja" class="form-select form-select-sm" onchange="applyFilters()"></select></div>
                    <div class="mb-3"><label style="font-size:0.7rem; color:var(--cacique-yellow);">DIAGNÓSTICO</label><select id="filterFalha" class="form-select form-select-sm" onchange="applyFilters()"></select></div>
                    <button class="btn btn-sm btn-outline-warning w-100" onclick="resetFilters()">LIMPAR TUDO</button>
                </div>
            </div>
            <div class="sidebar-footer">
                Todos os direitos reservados a<br><strong>Rafael S. Nascimento</strong>
            </div>
        </nav>

        <main class="col-md-10 px-4 py-4">
            <div class="row g-3 mb-4">
                <div class="col-md-3"><div class="card kpi-card p-3 text-center"><div class="kpi-title">Ocorrências</div><div id="kpiTotal" class="kpi-value">-</div></div></div>
                <div class="col-md-3"><div class="card kpi-card p-3 text-center"><div class="kpi-title">Maior Gargalo</div><div id="kpiMotivo" class="kpi-value" style="font-size:0.85rem; color:#d35400;">-</div></div></div>
                <div class="col-md-3"><div class="card kpi-card p-3 text-center"><div id="kpiLojaTitle" class="kpi-title">Loja Crítica</div><div id="kpiLoja" class="kpi-value">-</div></div></div>
                <div class="col-md-3"><div class="card kpi-card p-3 text-center" style="border-top-color: var(--cacique-red);"><div class="kpi-title" style="color:var(--cacique-red)">Erros de Venda</div><div id="kpiErros" class="kpi-value" style="color:var(--cacique-red)">-</div></div></div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-7"><div class="card p-4"><h5>Evolução Temporal</h5><div class="chart-container"><canvas id="canvasTime"></canvas></div></div></div>
                <div class="col-md-5"><div class="card p-4"><h5>Ranking de Diagnósticos</h5><div class="chart-container"><canvas id="canvasBarFalha"></canvas></div></div></div>
            </div>

            <div class="row g-3">
                <div class="col-md-6"><div class="card p-4"><h5>Volume x Erro (Por Loja)</h5><div class="chart-container"><canvas id="canvasStore"></canvas></div></div></div>
                <div class="col-md-6"><div class="card p-4"><h5>Top 5 Erros por Vendedor</h5><div class="chart-container"><canvas id="canvasSellerError"></canvas></div></div></div>
            </div>
        </main>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
let fullData = [];
let currentFiltered = [];
let charts = {};
const TEXT_BLACK = '#121212';
const TEXT_RED = '#c0392b';

function fixText(text) {
    if (!text) return "";
    return text.toString().trim()
        .replace(/RECLAMA[\?]+O/gi, "RECLAMAÇÃO").replace(/SOLICITA[\?]+O/gi, "SOLICITAÇÃO")
        .replace(/INFORMA[\?]+O/gi, "INFORMAÇÃO").replace(/ENDERE[\? ]+O/gi, "ENDEREÇO")
        .replace(/DIFEREN[\? ]+A/gi, "DIFERENÇA").replace(/LIGA[\?]+ES/gi, "LIGAÇÕES")
        .replace(/ATEN[\?]+O/gi, "ATENÇÃO").replace(/N[\?]+O/gi, "NÃO")
        .replace(/[\?]+/g, " ");
}

function parseDate(str) {
    if(!str) return null;
    const p = str.split('/');
    if(p.length < 3) return null;
    let dia = parseInt(p[0].trim()), mes = parseInt(p[1]) - 1, ano = parseInt(p[2].split(' ')[0]);
    if (ano < 100) ano += 2000;
    return new Date(ano, mes, dia);
}

document.getElementById('csvInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.readAsText(file, "ISO-8859-1");
    reader.onload = function(event) {
        Papa.parse(event.target.result, {
            header: true, delimiter: ";", skipEmptyLines: true,
            complete: function(results) {
                fullData = results.data.map(row => {
                    const cleanRow = {};
                    Object.keys(row).forEach(key => {
                        const cleanKey = fixText(key).replace(/\s+/g, '');
                        cleanRow[cleanKey] = fixText(row[key]);
                    });
                    return cleanRow;
                });
                populateFilters(fullData);
                setDefaultMonth();
                document.getElementById('controls').style.display = 'block';
                applyFilters();
            }
        });
    };
});

function setDefaultMonth() {
    const now = new Date();
    document.getElementById('dateStart').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('dateEnd').value = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
}

function populateFilters(data) {
    const lojas = [...new Set(data.map(i => i.LOJA))].filter(x => x).sort();
    const falhas = [...new Set(data.map(i => i.DETALHEFALHA || i.DETALHE_FALHA))].filter(x => x).sort();
    fillSelect('filterLoja', lojas, "TODAS AS LOJAS");
    fillSelect('filterFalha', falhas, "TODAS AS FALHAS");
}

function fillSelect(id, list, first) {
    const s = document.getElementById(id);
    s.innerHTML = `<option value="all">${first}</option>` + list.map(i => `<option value="${i}">${i}</option>`).join('');
}

function applyFilters() {
    const lSel = document.getElementById('filterLoja').value;
    const fSel = document.getElementById('filterFalha').value;
    const dStart = document.getElementById('dateStart').value ? new Date(document.getElementById('dateStart').value + "T00:00:00") : null;
    const dEnd = document.getElementById('dateEnd').value ? new Date(document.getElementById('dateEnd').value + "T23:59:59") : null;

    currentFiltered = fullData.filter(row => {
        const rDate = parseDate(row.DATA);
        const rFalha = row.DETALHEFALHA || row.DETALHE_FALHA || "";
        const matchDate = (!rDate || (!dStart || rDate >= dStart) && (!dEnd || rDate <= dEnd));
        const matchL = (lSel === 'all' || row.LOJA === lSel);
        const matchF = (fSel === 'all' || rFalha === fSel);
        return matchDate && matchL && matchF;
    });
    
    const titleEl = document.getElementById('kpiLojaTitle');
    if (lSel !== 'all') { titleEl.innerText = "Loja Observada"; titleEl.classList.add('kpi-observed'); }
    else { titleEl.innerText = "Loja Crítica"; titleEl.classList.remove('kpi-observed'); }
    renderDashboard(currentFiltered);
}

function resetFilters() { setDefaultMonth(); document.getElementById('filterLoja').value = 'all'; document.getElementById('filterFalha').value = 'all'; applyFilters(); }

function openModal(vendedor) {
    const errors = currentFiltered.filter(row => {
        const isErro = (row['ERRO_VENDA?'] || row['ERRO_VENDA'] || "").toUpperCase().includes("SIM");
        return row.VENDEDOR === vendedor && isErro;
    });
    document.getElementById('modalTitle').innerText = `AUDITORIA: ${vendedor} (${errors.length} Erros)`;
    document.getElementById('modalBody').innerHTML = errors.map(e => `
        <tr>
            <td>${e.DATA || ''}</td><td>${e.ATENDENTE || ''}</td><td>${e.LOJA || ''}</td>
            <td>${e.VENDEDOR || ''}</td><td>${e.PEDIDO || ''}</td><td>${e.ERRO_VENDA || e['ERRO_VENDA?'] || ''}</td>
            <td>${e.RECLAMAÇÃO || e.RECLAMACAO || ''}</td><td>${e.DETALHEFALHA || e.DETALHE_FALHA || ''}</td>
            <td>${e.STATUS || ''}</td><td>${e.TRATATIVA || ''}</td>
        </tr>
    `).join('');
    document.getElementById('errorModal').style.display = 'block';
}

function closeModal() { document.getElementById('errorModal').style.display = 'none'; }

function renderDashboard(data) {
    const counts = { date: {}, falha: {}, storeVol: {}, storeErr: {}, sellerError: {}, totalErros: 0 };
    let totalDiag = 0;
    
    data.forEach(row => {
        const rDate = parseDate(row.DATA);
        const dDisp = rDate ? rDate.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}) : null;
        const lj = row.LOJA || "N/A", vend = row.VENDEDOR || "N/A", fName = row.DETALHEFALHA || row.DETALHE_FALHA || "";
        const isErro = (row['ERRO_VENDA?'] || row['ERRO_VENDA'] || "").toUpperCase().includes("SIM");
        if(dDisp) counts.date[dDisp] = (counts.date[dDisp] || 0) + 1;
        if(fName.trim() !== "") { counts.falha[fName] = (counts.falha[fName] || 0) + 1; totalDiag++; }
        counts.storeVol[lj] = (counts.storeVol[lj] || 0) + 1;
        if(isErro) { counts.storeErr[lj] = (counts.storeErr[lj] || 0) + 1; counts.sellerError[vend] = (counts.sellerError[vend] || 0) + 1; counts.totalErros++; }
    });

    Object.values(charts).forEach(c => c && c.destroy());

    // Gráficos Restaurados V36/V37
    const sortedDates = Object.keys(counts.date).sort();
    charts.time = new Chart(document.getElementById('canvasTime'), {
        type: 'line', data: { labels: sortedDates, datasets: [{ data: sortedDates.map(d => counts.date[d]), borderColor: TEXT_BLACK, backgroundColor: 'rgba(255, 219, 0, 0.4)', fill: true, tension: 0.4, pointRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false, grace: '30%' }, x: { grid: { display: false }, ticks: { color: TEXT_BLACK, font: { weight: 'bold' } } } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', offset: 8, color: TEXT_BLACK, font: { weight: 'bold', size: 11 } } } }
    });

    const sortedF = Object.entries(counts.falha).sort((a,b) => b[1]-a[1]).slice(0, 8);
    charts.falhas = new Chart(document.getElementById('canvasBarFalha'), {
        type: 'bar', data: { labels: sortedF.map(f => f[0]), datasets: [{ data: sortedF.map(f => f[1]), backgroundColor: '#ffdb00', borderRadius: 5 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false }, ticks: { color: TEXT_BLACK, font: { weight: 'bold', size: 9 } } } }, plugins: { legend: { display: false }, datalabels: { font: { weight: 'bold' }, formatter: (v) => `${v} (${totalDiag > 0 ? ((v/totalDiag)*100).toFixed(0) : 0}%)` } } }
    });

    const storeL = Object.keys(counts.storeVol).sort();
    charts.store = new Chart(document.getElementById('canvasStore'), {
        type: 'bar', data: { labels: storeL, datasets: [{ label: 'Volume', data: storeL.map(l => counts.storeVol[l]), backgroundColor: '#ffdb00' }, { label: 'Erros', data: storeL.map(l => counts.storeErr[l] || 0), backgroundColor: '#e74c3c' }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false }, ticks: { color: TEXT_BLACK, font: { weight: '900', size: 10 } } }, y: { display: false, grace: '35%' } }, plugins: { datalabels: { anchor: 'end', align: 'top', font: { weight: '900', size: 11 }, color: (ctx) => ctx.dataset.label === 'Volume' ? TEXT_BLACK : TEXT_RED, formatter: (v, ctx) => `${v} (${((v/(ctx.dataset.label === 'Volume' ? data.length : counts.totalErros))*100).toFixed(0)}%)` } } }
    });

    const topS = Object.entries(counts.sellerError).sort((a,b) => b[1]-a[1]).slice(0, 5);
    charts.seller = new Chart(document.getElementById('canvasSellerError'), {
        type: 'bar', data: { labels: topS.map(s => s[0]), datasets: [{ data: topS.map(s => s[1]), backgroundColor: '#121212', borderRadius: 5 }] },
        options: { 
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            onClick: (e, el) => { if(el.length > 0) openModal(topS[el[0].index][0]); },
            scales: { x: { display: false }, y: { grid: { display: false }, ticks: { color: TEXT_BLACK, font: { weight: '900', size: 10 } } } },
            plugins: { legend: { display: false }, datalabels: { color: '#fff', font: { weight: '900', size: 11 }, formatter: (v) => `${v} (${counts.totalErros > 0 ? ((v/counts.totalErros)*100).toFixed(1) : 0}%)` } }
        }
    });

    document.getElementById('kpiTotal').innerText = data.length;
    document.getElementById('kpiErros').innerText = `${counts.totalErros} (${data.length > 0 ? ((counts.totalErros/data.length)*100).toFixed(1) : 0}%)`;
    document.getElementById('kpiMotivo').innerText = Object.entries(counts.falha).sort((a,b) => b[1]-a[1])[0]?.[0] || "-";
    document.getElementById('kpiLoja').innerText = (document.getElementById('filterLoja').value !== 'all') ? document.getElementById('filterLoja').value : (Object.entries(counts.storeErr).sort((a,b) => b[1]-a[1])[0]?.[0] || "-");
}
</script>
</body>
</html>
